{% extends 'app/pages/base.html' %}
{% load bootstrap4 %}
{% load app_tags %}

{% block customstyles %}
  <link href="https://unpkg.com/cloudinary-video-player/dist/cld-video-player.min.css" rel="stylesheet">
{% endblock customstyles %}


{% block title %}Comments{% endblock title %}

{% block content %}
  <section class='my-5 col-md-12'>
    <div class='card'>
      <h4 class='card-header'>
        Your Public Comments
      </h4>
      <div class="card-body">
        {% comment %}
        <div class='card-title'>
          <p>
            These are your public comments.
          </p>
        </div>
        {% endcomment %}
        <div class='card-text'>
          <table class='table'>
            <thead>
              <tr>
                <th>Comment</th>
                <th>Status</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody>
              {% for personal in personals %}
                <tr>
                  {% if personal.polymorphic_ctype.name == 'Written Comment' %}
                    <td>
                      {{personal.text}}
                    </td>
                  {% else %}
                    <td>
                      <video
                        id="{{personal.video.id}}"
                        controls
                        class="cld-video-player"
                        data-cld-public-id="{{personal.video.name}}"
                      >
                      </video>
                    </td>
                  {% endif %}
                  <td>
                    {{ personal.get_state_display }}
                  </td>
                  <td>
                    <a href='{% url "comment-delete" personal.id %}'><span class='text-danger'>Delete</span></a>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan=3>
                    Click one of the buttons below to make a public comment; once approved, it will appear on the website homepage.
                  <td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class='card-footer'>
        <div class='list-inline'>
          {% url 'submit-spoken-comment' as spoken_url_comment %}
          <li class='list-inline-item'>{% bootstrap_button "Make Spoken Comment" button_type='link' href=spoken_url_comment size='large' button_class='btn-primary' extra_classes='m-2' %}</li>
          {% url 'submit-written-comment' as written_url_comment %}
          <li class='list-inline-item'>{% bootstrap_button "Make Written Comment" button_type='link' href=written_url_comment size='large' button_class='btn-success' extra_classes='m-2'%}</li>
        </div>
      </div>
    </div>
  </section>
  <section class='my-5 col-md-12'>
    <div class='card'>
      <h4 class='card-header'>
        All Public Comments
      </h4>
      <div class="card-body">
        <div class='card-text'>
          <table class='table'>
            <thead>
              <tr class='row'>
                <th scope='col' class='col-5'>Name</th>
                <th scope='col' class='col-7'>Comments</th>
              </tr>
            </thead>
            <tbody>
              {% for public in publics %}
                <tr class='row'>
                  <td class='col-5'>
                    {{public.account.name}}<br>
                    <ul class='list-inline'>
                      {% if public.account.role == 1 %}
                        <li class='list-inline-item'>
                            <span class="badge badge-warning">Parent</span>
                        </li>
                      {% elif public.account.role == 2 %}
                        <li class='list-inline-item'>
                            <span class="badge badge-success">Student</span>
                        </li>
                      {% elif public.account.role == 3 %}
                        <li class='list-inline-item'>
                            <span class="badge badge-danger">Teacher</span>
                        </li>
                      {% endif %}
                      {% if public.account.is_voter %}
                        <li class='list-inline-item'>
                            <span class="badge badge-primary">Registered Voter</span>
                        </li>
                      {% endif %}
                      {% if public.account.zone %}
                        <li class='list-inline-item'>
                          <span class="badge badge-light">{{account.get_zone_display}}</span>
                        </li>
                      {% endif %}
                    </ul>
                  </td>
                  <td class='col-7'>
                    {% if public.polymorphic_ctype.name == 'Written Comment' %}
                      {% if public.wordcount < 31 %}
                        {{public.text}}
                      {% else %}
                        <div class="collapse show" id="public-{{public.id}}">
                          {{public.text|truncatewords:30}}
                        </div>
                        <div class="collapse" id="public-{{public.id}}">
                          {{public.text}}
                        </div>
                        <a data-toggle="collapse" href="#public-{{public.id}}"><small>more</small></a>
                      {% endif %}
                    {% else %}
                      <video
                        id="{{public.video.id}}"
                        controls
                        class="cld-video-player"
                        data-cld-public-id="{{public.video.name}}"
                      >
                      </video>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

{% endblock content %}

{% block scripts %}
  <script src="https://unpkg.com/cloudinary-core/cloudinary-core-shrinkwrap.min.js" type="text/javascript"></script>
  <script src="https://unpkg.com/cloudinary-video-player/dist/cld-video-player.min.js" type="text/javascript"></script>
  <script>
    let cloudName = '{% get_env_var "CLOUDINARY_NAME"%}';
    let cld = cloudinary.Cloudinary.new({
      cloud_name: cloudName
    });
    let players = cld.videoPlayers('.cld-video-player', {
      showLogo: false,
      sourceTypes: ['hls', 'dash'],
      sourceTransformation: {
        'hls': [{ streaming_profile: 'hd' }],
        'dash': [{ streaming_profile: 'hd' }],
      }
    });
  </script>
{% endblock scripts %}
